import subprocess, shlex, re, time

ALLOWED = {
  "get": ["pods", "nodes", "events", "deployments", "services", "ingress", "replicasets"],
  "describe": ["pod", "node", "deployment", "service"]
}

def _redact(s: str) -> str:
    s = re.sub(r'(?i)(password|token|secret)[=:]\s*\S+', r'\1=REDACTED', s)
    return s

def run(action: str, kind: str, name: str | None = None, namespace: str | None = None) -> dict:
    if action not in ALLOWED or kind not in ALLOWED[action]:
        return {"ok": False, "error": "Not allowed", "action": action, "kind": kind}
    parts = ["kubectl", action, kind]
    if name: parts.append(name)
    if namespace: parts += ["-n", namespace]
    if action == "get" and kind in ["pods", "nodes"]:
        parts += ["-o", "wide"]
    started = time.time()
    try:
        out = subprocess.check_output(parts, stderr=subprocess.STDOUT, timeout=8)
        text = _redact(out.decode())
        return {"ok": True, "cmd": " ".join(shlex.quote(p) for p in parts),
                "ms": int((time.time()-started)*1000), "text": text}
    except subprocess.CalledProcessError as e:
        return {"ok": False, "cmd": " ".join(parts), "ms": int((time.time()-started)*1000),
                "error": e.output.decode()}
    except FileNotFoundError:
        return {"ok": False, "cmd": " ".join(parts), "ms": int((time.time()-started)*1000),
                "error": "kubectl not found in PATH (stub environment)."}
